<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Treap 学习笔记 | ChungZH's Blog</title><meta property="og:site_name" content="ChungZH's Blog"><meta property="og:title" content="Treap 学习笔记 | ChungZH's Blog"><meta itemprop=name content="Treap 学习笔记 | ChungZH's Blog"><meta name=twitter:title content="Treap 学习笔记 | ChungZH's Blog"><meta name=application-name content="Treap 学习笔记 | ChungZH's Blog"><link rel="shortcut icon" href=/BlogFavicon16.png><meta name=twitter:card content="summary"><meta name=description content="Welcome to my blog!"><meta name=twitter:description content="Welcome to my blog!"><meta itemprop=description content="Welcome to my blog!"><meta property="og:description" content="Welcome to my blog!"><link rel=stylesheet href="https://blog.chungzh.cn/sass/main.min.76081452354a922312311970ac5598f4c4adf0a9024d15bc823f6b3c8474e0d7.css" integrity="sha256-dggUUjVKkiMSMRlwrFWY9MSt8KkCTRW8gj9rPIR04Nc="></head><body class="bg-white dark:bg-slate-900 text-slate-500 dark:text-slate-400"><header class="sticky top-0 z-40"><div class="w-full backdrop-blur bg-white/80 dark:bg-slate-900/75 lg:border-b lg:border-slate-900/10 dark:border-slate-50/[0.06]"><div class="py-4 border-b border-slate-900/10 lg:px-8 lg:border-0 dark:border-slate-300/10 mx-4 lg:mx-0"><div class="px-20 relative flex flex-wrap justify-between"><div class="relative flex items-center"><a href=/><div class="flex gap-3 items-center text-xl font-bold text-slate-800 dark:text-slate-200"><img class="w-auto h-8" src=/BlogFavicon16.png title=logo>
<span class="hover:text-sky-500 dark:hover:text-sky-400">ChungZH's Blog</span></div></a></div><div class="relative flex items-center"><div class="flex gap-5 items-center leading-6 font-semibold text-slate-700 dark:text-slate-200"><a class="hover:text-sky-500 dark:hover:text-sky-400" href=/about/>关于</a>
<a class="hover:text-sky-500 dark:hover:text-sky-400" href=/friends/>友链</a>
<a class="hover:text-sky-500 dark:hover:text-sky-400" href=/archives/>存档</a>
<a class="hover:text-sky-500 dark:hover:text-sky-400" href=/tags/>标签</a></div></div></div></div></nav></header><div class="max-w-3xl mx-auto pb-28"><main class="max-w-[52rem] mx-auto py-10"><div class=container><article><header class=article-header><div class=thumb><div><div class=post-tags><a class=tag href=/tags/oi/>#OI</a>
<a class=tag href=/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/>#数据结构</a>
<a class=tag href=/tags/treap/>#Treap</a></div><h1 class=post-title>Treap 学习笔记</h1><div class=post-meta>By ChungZH<div class="font-bold text-sky-500 dark:text-sky-400">·</div><time>February 09, 2022</time><div class="font-bold text-sky-500 dark:text-sky-400">·</div>5 minutes</div></div></div></header></article><aside class=toc><nav id=TableOfContents><ul><li><a href=#二叉搜索树bst>二叉搜索树（BST）</a></li><li><a href=#treap>Treap</a><ul><li><a href=#旋转式-treap>旋转式 Treap</a></li><li><a href=#无旋-treap>无旋 Treap</a></li></ul></li></ul></nav></aside><div class=article-post><blockquote><p>Treap = Tree + Heap</p></blockquote><h2 id=二叉搜索树bst>二叉搜索树（BST）</h2><p>在学习 Treap 之前，需要先了解一下二叉搜索树（BST, Binary Search Tree）：</p><ul><li><p>设 $x$ 是二叉搜索树中的一个结点。如果 $y$ 是 $x$ 左子树中的一个结点，那么 $y.key \lt x.key$。如果 $y$ 是 $x$ 右子树中的一个结点，那么 $y.key \gt x.key$。</p></li><li><p>BST 上的基本操作所花费的时间与这棵树的高度成正比。对于一个有 $n$ 个结点的二叉搜索树中，这些操作的最优时间复杂度为 $O(\log n)$，最坏为 $O(n)$。随机构造这样一棵二叉搜索树的期望高度为 $O(\log n)$。然而，当这棵树退化成链时，则同样的操作就要花费 $O(n)$ 的最坏运行时间。</p></li></ul><p>由于普通 BST 容易退化，对于它的实现就不再赘述。在实践中需要使用如 Treap 这样的平衡二叉搜索树。</p><h2 id=treap>Treap</h2><p>顾名思义，Treap 是树和堆的结合。它的数据结构既是一个二叉搜索树，又是一个二叉堆。</p><p>在 Treap 的每个结点中，除了 $key$ 值，还要保存一个 $fix$（更常见的是 $priority$）值。这个值是随机值，以它为依据来同时建立最大堆（或最小堆）。因为 $fix$ 值是随机的，所以可以让这棵树更加平衡，高度更接近 $O(\log n)$。它的各种操作期望时间复杂度都是 $O(\log n)$。</p><h3 id=旋转式-treap>旋转式 Treap</h3><p>旋转式 Treap 的常数较小。</p><h4 id=旋转>旋转</h4><p>左旋/右旋操作不会破坏 BST 的性质，并可以通过它来维护堆，使树平衡。</p><p><img src=https://raw.githubusercontent.com/ChungZH/img/main/treap/zigzag.jpg alt=zigzag.jpg></p><p>如图，以右旋为例。假设现在左边树 $b$ 的 $fix$ 值大于 $a$ 的 $fix$ 值，然而 $b$ 是 $a$ 的儿子，那么就不符合最大堆的性质，需要进行右旋，变成了右边的树。</p><p>但是为什么在旋转的过程中没有破坏 BST 的性质呢？设 $c \in C, d \in D, e \in E$。由左树知 $c \lt b \lt d \lt a \lt e$。再由旋转之后树的结构可以得出 $c \lt b \lt d \lt a \lt e$，这两个式子是一样的。所以，这棵树依然是 BST。</p><p>在插入和删除操作中都要按需进行旋转操作。</p><h4 id=插入>插入</h4><p>根据 BST 的性质，找到相应的位置创建新叶子结点就可以了。如果不符合最大堆性质，进行旋转操作。</p><h4 id=删除>删除</h4><p>删除一个元素时，可以对被删除的结点分类讨论：</p><ol><li>没有子结点：直接就成空的了</li><li>只有一个子结点：把被删除结点设成它仅有的儿子即可</li><li>有两个子结点：选出两个儿子中 $fix$ 值较大的一个，通过旋转操作把它设成新的根，这样要删除的结点就只有一个儿子了，按照情况 2 处理。这种方法保证满足了 BST 和最大堆的性质。</li></ol><p>在程序实现时，实际上情况 1 和 2 的代码是一样的，所以只用分两类。</p><p>以 <a href=https://www.luogu.com.cn/problem/P3369>P3369 【模板】普通平衡树 - 洛谷</a> 为例，代码如下。</p><div class=highlight><div style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">126
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">127
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">128
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">129
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">130
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">131
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">132
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">133
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">134
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">135
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">136
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">147
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">148
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">149
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">150
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">151
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">156
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">157
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;algorithm&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cstdio&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cstdlib&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;cstring&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;iostream&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;vector&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>using</span> <span style=color:#00a8c8>namespace</span> <span style=color:#111>std</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>const</span> <span style=color:#00a8c8>int</span> <span style=color:#111>INF</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1000000009</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>struct</span> <span style=color:#75af00>NODE</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>int</span> <span style=color:#111>val</span><span style=color:#111>,</span> <span style=color:#111>fix</span><span style=color:#111>,</span> <span style=color:#111>size</span><span style=color:#111>;</span> <span style=color:#75715e>// size 指树的总结点数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#111>NODE</span> <span style=color:#f92672>*</span><span style=color:#111>left</span><span style=color:#111>,</span> <span style=color:#f92672>*</span><span style=color:#111>right</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#111>NODE</span><span style=color:#111>(</span><span style=color:#00a8c8>const</span> <span style=color:#00a8c8>int</span> <span style=color:#111>val</span><span style=color:#111>)</span> <span style=color:#f92672>:</span> <span style=color:#111>val</span><span style=color:#111>(</span><span style=color:#111>val</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>fix</span> <span style=color:#f92672>=</span> <span style=color:#111>rand</span><span style=color:#111>();</span>
</span></span><span style=display:flex><span>    <span style=color:#111>left</span> <span style=color:#f92672>=</span> <span style=color:#111>right</span> <span style=color:#f92672>=</span> <span style=color:#111>NULL</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>size</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>};</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>void</span> <span style=color:#75af00>maintain</span><span style=color:#111>(</span><span style=color:#111>NODE</span> <span style=color:#f92672>*&amp;</span><span style=color:#111>p</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>size</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span> <span style=color:#f92672>!=</span> <span style=color:#111>NULL</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>size</span> <span style=color:#f92672>+=</span> <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span><span style=color:#f92672>-&gt;</span><span style=color:#111>size</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span> <span style=color:#f92672>!=</span> <span style=color:#111>NULL</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>size</span> <span style=color:#f92672>+=</span> <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span><span style=color:#f92672>-&gt;</span><span style=color:#111>size</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>void</span> <span style=color:#75af00>rightRotate</span><span style=color:#111>(</span><span style=color:#111>NODE</span> <span style=color:#f92672>*&amp;</span><span style=color:#111>p</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#111>NODE</span> <span style=color:#f92672>*</span><span style=color:#111>tmp</span> <span style=color:#f92672>=</span> <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span> <span style=color:#f92672>=</span> <span style=color:#111>tmp</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#111>tmp</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span> <span style=color:#f92672>=</span> <span style=color:#111>p</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#111>p</span> <span style=color:#f92672>=</span> <span style=color:#111>tmp</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#111>maintain</span><span style=color:#111>(</span><span style=color:#111>tmp</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#111>maintain</span><span style=color:#111>(</span><span style=color:#111>tmp</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>void</span> <span style=color:#75af00>leftRotate</span><span style=color:#111>(</span><span style=color:#111>NODE</span> <span style=color:#f92672>*&amp;</span><span style=color:#111>p</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#111>NODE</span> <span style=color:#f92672>*</span><span style=color:#111>tmp</span> <span style=color:#f92672>=</span> <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span> <span style=color:#f92672>=</span> <span style=color:#111>tmp</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#111>tmp</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span> <span style=color:#f92672>=</span> <span style=color:#111>p</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#111>p</span> <span style=color:#f92672>=</span> <span style=color:#111>tmp</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#111>maintain</span><span style=color:#111>(</span><span style=color:#111>tmp</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#111>maintain</span><span style=color:#111>(</span><span style=color:#111>tmp</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>void</span> <span style=color:#75af00>insert</span><span style=color:#111>(</span><span style=color:#111>NODE</span> <span style=color:#f92672>*&amp;</span><span style=color:#111>p</span><span style=color:#111>,</span> <span style=color:#00a8c8>const</span> <span style=color:#00a8c8>int</span> <span style=color:#111>value</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>p</span> <span style=color:#f92672>==</span> <span style=color:#111>NULL</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>p</span> <span style=color:#f92672>=</span> <span style=color:#00a8c8>new</span> <span style=color:#111>NODE</span><span style=color:#111>(</span><span style=color:#111>value</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>value</span> <span style=color:#f92672>&lt;=</span> <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>val</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>insert</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span><span style=color:#111>,</span> <span style=color:#111>value</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span><span style=color:#f92672>-&gt;</span><span style=color:#111>fix</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>fix</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>      <span style=color:#111>rightRotate</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>insert</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span><span style=color:#111>,</span> <span style=color:#111>value</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span><span style=color:#f92672>-&gt;</span><span style=color:#111>fix</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>fix</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>      <span style=color:#111>leftRotate</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span><span style=display:flex><span>  <span style=color:#111>maintain</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>int</span> <span style=color:#75af00>count</span><span style=color:#111>(</span><span style=color:#00a8c8>const</span> <span style=color:#111>NODE</span> <span style=color:#f92672>*</span><span style=color:#111>p</span><span style=color:#111>,</span> <span style=color:#00a8c8>const</span> <span style=color:#00a8c8>int</span> <span style=color:#111>value</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#f92672>!</span><span style=color:#111>p</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>val</span> <span style=color:#f92672>==</span> <span style=color:#111>value</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#ae81ff>1</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>value</span> <span style=color:#f92672>&lt;=</span> <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>val</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>count</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span><span style=color:#111>,</span> <span style=color:#111>value</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>return</span> <span style=color:#111>count</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span><span style=color:#111>,</span> <span style=color:#111>value</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>void</span> <span style=color:#75af00>remove</span><span style=color:#111>(</span><span style=color:#111>NODE</span> <span style=color:#f92672>*&amp;</span><span style=color:#111>p</span><span style=color:#111>,</span> <span style=color:#00a8c8>const</span> <span style=color:#00a8c8>int</span> <span style=color:#111>value</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#f92672>!</span><span style=color:#111>p</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>val</span> <span style=color:#f92672>==</span> <span style=color:#111>value</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span> <span style=color:#f92672>==</span> <span style=color:#111>NULL</span> <span style=color:#f92672>||</span> <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span> <span style=color:#f92672>==</span> <span style=color:#111>NULL</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>      <span style=color:#111>NODE</span> <span style=color:#f92672>*</span><span style=color:#111>tmp</span> <span style=color:#f92672>=</span> <span style=color:#111>p</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>      <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>        <span style=color:#111>p</span> <span style=color:#f92672>=</span> <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>      <span style=color:#00a8c8>else</span>
</span></span><span style=display:flex><span>        <span style=color:#111>p</span> <span style=color:#f92672>=</span> <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>      <span style=color:#00a8c8>delete</span> <span style=color:#111>tmp</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span><span style=color:#f92672>-&gt;</span><span style=color:#111>fix</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span><span style=color:#f92672>-&gt;</span><span style=color:#111>fix</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>      <span style=color:#111>rightRotate</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>      <span style=color:#111>remove</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span><span style=color:#111>,</span> <span style=color:#111>value</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>      <span style=color:#111>maintain</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>      <span style=color:#111>leftRotate</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>      <span style=color:#111>remove</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span><span style=color:#111>,</span> <span style=color:#111>value</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>      <span style=color:#111>maintain</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>value</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>val</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>remove</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span><span style=color:#111>,</span> <span style=color:#111>value</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>maintain</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>remove</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span><span style=color:#111>,</span> <span style=color:#111>value</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>maintain</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>int</span> <span style=color:#75af00>getrank</span><span style=color:#111>(</span><span style=color:#00a8c8>const</span> <span style=color:#111>NODE</span> <span style=color:#f92672>*</span><span style=color:#111>p</span><span style=color:#111>,</span> <span style=color:#00a8c8>int</span> <span style=color:#111>value</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#f92672>!</span><span style=color:#111>p</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>INF</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>int</span> <span style=color:#111>leftsize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span> <span style=color:#f92672>!=</span> <span style=color:#111>NULL</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>leftsize</span> <span style=color:#f92672>=</span> <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span><span style=color:#f92672>-&gt;</span><span style=color:#111>size</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>val</span> <span style=color:#f92672>==</span> <span style=color:#111>value</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>min</span><span style=color:#111>(</span><span style=color:#111>leftsize</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#111>,</span> <span style=color:#111>getrank</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span><span style=color:#111>,</span> <span style=color:#111>value</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>value</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>val</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>getrank</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span><span style=color:#111>,</span> <span style=color:#111>value</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>value</span> <span style=color:#f92672>&gt;</span> <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>val</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>leftsize</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#111>getrank</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span><span style=color:#111>,</span> <span style=color:#111>value</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>int</span> <span style=color:#75af00>find</span><span style=color:#111>(</span><span style=color:#00a8c8>const</span> <span style=color:#111>NODE</span> <span style=color:#f92672>*</span><span style=color:#111>p</span><span style=color:#111>,</span> <span style=color:#00a8c8>int</span> <span style=color:#111>rank</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#f92672>!</span><span style=color:#111>p</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>int</span> <span style=color:#111>leftsize</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span> <span style=color:#f92672>!=</span> <span style=color:#111>NULL</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>leftsize</span> <span style=color:#f92672>=</span> <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span><span style=color:#f92672>-&gt;</span><span style=color:#111>size</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>leftsize</span> <span style=color:#f92672>&gt;=</span> <span style=color:#111>rank</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>find</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span><span style=color:#111>,</span> <span style=color:#111>rank</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>leftsize</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>==</span> <span style=color:#111>rank</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>val</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>else</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>find</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span><span style=color:#111>,</span> <span style=color:#111>rank</span> <span style=color:#f92672>-</span> <span style=color:#111>leftsize</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>int</span> <span style=color:#75af00>getpre</span><span style=color:#111>(</span><span style=color:#00a8c8>const</span> <span style=color:#111>NODE</span> <span style=color:#f92672>*</span><span style=color:#111>p</span><span style=color:#111>,</span> <span style=color:#00a8c8>int</span> <span style=color:#111>value</span><span style=color:#111>)</span> <span style=color:#111>{</span> <span style=color:#75715e>// 前驱
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#f92672>!</span><span style=color:#111>p</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#f92672>-</span><span style=color:#111>INF</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>val</span> <span style=color:#f92672>&gt;=</span> <span style=color:#111>value</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>getpre</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span><span style=color:#111>,</span> <span style=color:#111>value</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>else</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>max</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>val</span><span style=color:#111>,</span> <span style=color:#111>getpre</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span><span style=color:#111>,</span> <span style=color:#111>value</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>int</span> <span style=color:#75af00>getnext</span><span style=color:#111>(</span><span style=color:#00a8c8>const</span> <span style=color:#111>NODE</span> <span style=color:#f92672>*</span><span style=color:#111>p</span><span style=color:#111>,</span> <span style=color:#00a8c8>int</span> <span style=color:#111>value</span><span style=color:#111>)</span> <span style=color:#111>{</span> <span style=color:#75715e>// 后继
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#f92672>!</span><span style=color:#111>p</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>INF</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>val</span> <span style=color:#f92672>&lt;=</span> <span style=color:#111>value</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>getnext</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>right</span><span style=color:#111>,</span> <span style=color:#111>value</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>else</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>min</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>val</span><span style=color:#111>,</span> <span style=color:#111>getnext</span><span style=color:#111>(</span><span style=color:#111>p</span><span style=color:#f92672>-&gt;</span><span style=color:#111>left</span><span style=color:#111>,</span> <span style=color:#111>value</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>int</span> <span style=color:#111>n</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span><span style=color:#111>NODE</span> <span style=color:#f92672>*</span><span style=color:#111>root</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>int</span> <span style=color:#75af00>main</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#111>scanf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;%d&#34;</span><span style=color:#111>,</span> <span style=color:#f92672>&amp;</span><span style=color:#111>n</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>while</span> <span style=color:#111>(</span><span style=color:#111>n</span><span style=color:#f92672>--</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>int</span> <span style=color:#111>opt</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>scanf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;%d %d&#34;</span><span style=color:#111>,</span> <span style=color:#f92672>&amp;</span><span style=color:#111>opt</span><span style=color:#111>,</span> <span style=color:#f92672>&amp;</span><span style=color:#111>x</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>opt</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>      <span style=color:#111>insert</span><span style=color:#111>(</span><span style=color:#111>root</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>opt</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>2</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>      <span style=color:#111>remove</span><span style=color:#111>(</span><span style=color:#111>root</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>opt</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>3</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>      <span style=color:#111>printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;%d</span><span style=color:#8045ff>\n</span><span style=color:#d88200>&#34;</span><span style=color:#111>,</span> <span style=color:#111>getrank</span><span style=color:#111>(</span><span style=color:#111>root</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>opt</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>4</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>      <span style=color:#111>printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;%d</span><span style=color:#8045ff>\n</span><span style=color:#d88200>&#34;</span><span style=color:#111>,</span> <span style=color:#111>find</span><span style=color:#111>(</span><span style=color:#111>root</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>opt</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>5</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>      <span style=color:#111>printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;%d</span><span style=color:#8045ff>\n</span><span style=color:#d88200>&#34;</span><span style=color:#111>,</span> <span style=color:#111>getpre</span><span style=color:#111>(</span><span style=color:#111>root</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>opt</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>6</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>      <span style=color:#111>printf</span><span style=color:#111>(</span><span style=color:#d88200>&#34;%d</span><span style=color:#8045ff>\n</span><span style=color:#d88200>&#34;</span><span style=color:#111>,</span> <span style=color:#111>getnext</span><span style=color:#111>(</span><span style=color:#111>root</span><span style=color:#111>,</span> <span style=color:#111>x</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>return</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=无旋-treap>无旋 Treap</h3><p>无旋 Treap 的核心操作是分裂、合并。</p><h4 id=分裂split>分裂（Split）</h4><p>分裂操作会将原 Treap 一分为二，第一个 Treap 中的结点关键值都小于等于 $key$，第二个中都大于 $key$。使用递归实现。</p><p>若当前关键值大于 $key$，那么<strong>当前结点连同右子树</strong>都属于第二个 Treap，继续往左子树递归。</p><p>若当前关键值小于等于 $key$，那<strong>当前结点连同左子树</strong>都属于第一个 Treap。继续往右子树递归。</p><p><img src=https://upload.wikimedia.org/wikipedia/commons/6/69/Treap_split.svg alt=img></p><div class=highlight><div style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#111>pair</span><span style=color:#f92672>&lt;</span><span style=color:#111>NODE</span> <span style=color:#f92672>*</span><span style=color:#111>,</span> <span style=color:#111>NODE</span> <span style=color:#f92672>*&gt;</span> <span style=color:#111>split</span><span style=color:#111>(</span><span style=color:#111>NODE</span> <span style=color:#f92672>*</span><span style=color:#111>u</span><span style=color:#111>,</span> <span style=color:#00a8c8>const</span> <span style=color:#00a8c8>int</span> <span style=color:#111>value</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>u</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nullptr</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>make_pair</span><span style=color:#111>(</span><span style=color:#00a8c8>nullptr</span><span style=color:#111>,</span> <span style=color:#00a8c8>nullptr</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>u</span><span style=color:#f92672>-&gt;</span><span style=color:#111>value</span> <span style=color:#f92672>&gt;</span> <span style=color:#111>value</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>auto</span> <span style=color:#111>tmp</span> <span style=color:#f92672>=</span> <span style=color:#111>split</span><span style=color:#111>(</span><span style=color:#111>u</span><span style=color:#f92672>-&gt;</span><span style=color:#111>ch</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>],</span> <span style=color:#111>value</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>u</span><span style=color:#f92672>-&gt;</span><span style=color:#111>ch</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>tmp</span><span style=color:#111>.</span><span style=color:#111>second</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>maintain</span><span style=color:#111>(</span><span style=color:#111>u</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>make_pair</span><span style=color:#111>(</span><span style=color:#111>tmp</span><span style=color:#111>.</span><span style=color:#111>first</span><span style=color:#111>,</span> <span style=color:#111>u</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span> <span style=color:#00a8c8>else</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>auto</span> <span style=color:#111>tmp</span> <span style=color:#f92672>=</span> <span style=color:#111>split</span><span style=color:#111>(</span><span style=color:#111>u</span><span style=color:#f92672>-&gt;</span><span style=color:#111>ch</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>],</span> <span style=color:#111>value</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>u</span><span style=color:#f92672>-&gt;</span><span style=color:#111>ch</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>tmp</span><span style=color:#111>.</span><span style=color:#111>first</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>    <span style=color:#111>maintain</span><span style=color:#111>(</span><span style=color:#111>u</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#75af00>make_pair</span><span style=color:#111>(</span><span style=color:#111>u</span><span style=color:#111>,</span> <span style=color:#111>tmp</span><span style=color:#111>.</span><span style=color:#111>second</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=合并merge>合并（Merge）</h4><p>合并函数接受两棵树，其中第一棵的值都小于第二棵。每一次根据两棵树的根的 $fix$ 值来确定新树的根，然后递归合并子树。</p><p>当两棵树任何一个为空时，返回另一个。</p><p><img src=https://upload.wikimedia.org/wikipedia/commons/a/a8/Treap_merge.svg alt=img></p><div class=highlight><div style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#111>NODE</span> <span style=color:#f92672>*</span><span style=color:#75af00>merge</span><span style=color:#111>(</span><span style=color:#111>NODE</span> <span style=color:#f92672>*</span><span style=color:#111>l</span><span style=color:#111>,</span> <span style=color:#111>NODE</span> <span style=color:#f92672>*</span><span style=color:#111>r</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>l</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nullptr</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>r</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>r</span> <span style=color:#f92672>==</span> <span style=color:#00a8c8>nullptr</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>l</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#111>l</span><span style=color:#f92672>-&gt;</span><span style=color:#111>fix</span> <span style=color:#f92672>&lt;</span> <span style=color:#111>r</span><span style=color:#f92672>-&gt;</span><span style=color:#111>fix</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>l</span><span style=color:#f92672>-&gt;</span><span style=color:#111>ch</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>merge</span><span style=color:#111>(</span><span style=color:#111>l</span><span style=color:#f92672>-&gt;</span><span style=color:#111>ch</span><span style=color:#111>[</span><span style=color:#ae81ff>1</span><span style=color:#111>],</span> <span style=color:#111>r</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#111>maintain</span><span style=color:#111>(</span><span style=color:#111>l</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>l</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span> <span style=color:#75715e>// else
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#111>r</span><span style=color:#f92672>-&gt;</span><span style=color:#111>ch</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>merge</span><span style=color:#111>(</span><span style=color:#111>l</span><span style=color:#111>,</span> <span style=color:#111>r</span><span style=color:#f92672>-&gt;</span><span style=color:#111>ch</span><span style=color:#111>[</span><span style=color:#ae81ff>0</span><span style=color:#111>]);</span>
</span></span><span style=display:flex><span>  <span style=color:#111>maintain</span><span style=color:#111>(</span><span style=color:#111>r</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>return</span> <span style=color:#111>r</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=插入-1>插入</h4><p>将树分裂成两个部分：$A=\lbrace x \mid x \le key \rbrace$、$B= \lbrace x \mid x \gt key \rbrace$，先将要插入的值合并入 $A$，最后合并 $A$ 和 $B$。</p><p><img src=https://upload.wikimedia.org/wikipedia/commons/3/35/Treap_insert.svg alt=img></p><div class=highlight><div style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#00a8c8>void</span> <span style=color:#75af00>insert</span><span style=color:#111>(</span><span style=color:#00a8c8>int</span> <span style=color:#111>value</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>auto</span> <span style=color:#111>tmp</span> <span style=color:#f92672>=</span> <span style=color:#111>split</span><span style=color:#111>(</span><span style=color:#111>root</span><span style=color:#111>,</span> <span style=color:#111>value</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#111>tmp</span><span style=color:#111>.</span><span style=color:#111>first</span> <span style=color:#f92672>=</span> <span style=color:#111>merge</span><span style=color:#111>(</span><span style=color:#111>tmp</span><span style=color:#111>.</span><span style=color:#111>first</span><span style=color:#111>,</span> <span style=color:#00a8c8>new</span> <span style=color:#111>NODE</span><span style=color:#111>(</span><span style=color:#111>value</span><span style=color:#111>));</span>
</span></span><span style=display:flex><span>  <span style=color:#111>root</span> <span style=color:#f92672>=</span> <span style=color:#111>merge</span><span style=color:#111>(</span><span style=color:#111>tmp</span><span style=color:#111>.</span><span style=color:#111>first</span><span style=color:#111>,</span> <span style=color:#111>tmp</span><span style=color:#111>.</span><span style=color:#111>second</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=删除-1>删除</h4><p>将树分裂成三个部分：$A= \lbrace x \mid x \lt key \rbrace$、$B= \lbrace x \mid x = key \rbrace$、$C= \lbrace x \mid x \gt key \rbrace$，然后合并 $A$ 和 $C$。</p><p><img src=https://upload.wikimedia.org/wikipedia/commons/6/62/Treap_erase.svg alt=img></p><div class=highlight><div style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#00a8c8>void</span> <span style=color:#75af00>erase</span><span style=color:#111>(</span><span style=color:#00a8c8>int</span> <span style=color:#111>value</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>auto</span> <span style=color:#111>tmp</span> <span style=color:#f92672>=</span> <span style=color:#111>split</span><span style=color:#111>(</span><span style=color:#111>root</span><span style=color:#111>,</span> <span style=color:#111>value</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>auto</span> <span style=color:#111>tmp2</span> <span style=color:#f92672>=</span> <span style=color:#111>split</span><span style=color:#111>(</span><span style=color:#111>tmp</span><span style=color:#111>.</span><span style=color:#111>second</span><span style=color:#111>,</span> <span style=color:#111>value</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>delete</span> <span style=color:#111>tmp2</span><span style=color:#111>.</span><span style=color:#111>first</span><span style=color:#111>;</span>
</span></span><span style=display:flex><span>  <span style=color:#111>root</span> <span style=color:#f92672>=</span> <span style=color:#111>merge</span><span style=color:#111>(</span><span style=color:#111>tmp</span><span style=color:#111>.</span><span style=color:#111>first</span><span style=color:#111>,</span> <span style=color:#111>tmp2</span><span style=color:#111>.</span><span style=color:#111>second</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></td></tr></table></div></div><hr><p>致谢：</p><ul><li>YWQ (Monad)</li><li><a href=https://oi-wiki.org/>OI Wiki</a> <a href=https://creativecommons.org/licenses/by-sa/4.0/deed.zh>CC BY-SA 4.0</a></li><li>《算法导论》</li><li><a href=https://cp-algorithms.com/index.html>Algorithms for Competitive Programming</a> <a href=https://creativecommons.org/licenses/by-sa/4.0/deed.en>CC BY-SA 4.0</a></li><li><a href=https://en.wikipedia.org/wiki/Treap>Treap - Wikipedia</a> <a href=https://creativecommons.org/licenses/by-sa/3.0/deed.zh>CC BY-SA 3.0</a></li></ul></div><div class=paginav><a rel=prev href=/articles/goodbye2021/ title="Previous post (older)"><span>Prev</span><div class=paginav-title>告别 2021</div></a><a class=text-right rel=next href=/articles/int-vs-longlong/ title="Next post (newer)"><span>Next</span><div class=paginav-title>关于 int 与 long long 的运算速度</div></a></div></div><div class=container><script src=https://giscus.app/client.js data-repo=ChungZH/ChungZH.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxNzcxMjMzNjI=" data-category=Comments data-category-id=DIC_kwDOCo6wIs4B_i5g data-mapping=title data-reactions-enabled=1 data-emit-metadata=0 data-theme=light crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector(".giscus iframe");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}const colorSchemeQueryList=window.matchMedia("(prefers-color-scheme: dark)"),setColorScheme=e=>{setGiscusTheme(e.matches?"dark_dimmed":"light")};setColorScheme(colorSchemeQueryList),colorSchemeQueryList.addEventListener("change",setColorScheme)</script></div></main><footer class="text-sm leading-6 mt-10"><div class="pt-10 pb-28 border-t border-slate-200 sm:flex justify-between text-slate-500 dark:border-slate-200/5"><div class="mb-6 sm:mb-0 sm:flex"><p>Made with ❤</p><p class="sm:ml-4 sm:pl-4 sm:border-l sm:border-slate-200 dark:sm:border-slate-200/5">By
<a class="hover:text-slate-900 dark:hover:text-slate-400" href=https://github.com/ChungZH>ChungZH</a></p><p class="sm:ml-4 sm:pl-4 sm:border-l sm:border-slate-200 dark:sm:border-slate-200/5">Theme hugo-klay</p></div></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css integrity=sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.js integrity=sha384-YNHdsYkH6gMx9y3mRkmcJ2mFUjTd0qNQQvY9VYZgQd7DcN7env35GzlmFaZ23JGp crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous onload='renderMathInElement(document.querySelector(".article-post"),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})'></script></footer></div></body></html>