---
title: ç‚¹åˆ†æ²»ç¬”è®°
tags:
- OI
- ç®—æ³•
- æ•°æ®ç»“æ„
- æ ‘çš„é‡å¿ƒ
- ç‚¹åˆ†æ²»
categories: å­¦ä¹ ç¬”è®°
date: 2022-08-02
katex: true
---

ç‚¹åˆ†æ²»ï¼Œå¤–å›½äººç§°ä¹‹ä¸º Centroid decompositionï¼Œé‡å¿ƒåˆ†è§£ã€‚

## ä½•ä¸ºæ ‘çš„é‡å¿ƒ

å­¦ä¹ é‡å¿ƒåˆ†è§£ä¹‹å‰ï¼Œè‡ªç„¶è¦å…ˆäº†è§£é‡å¿ƒã€‚

ä¸‹é¢ç»Ÿä¸€ç”¨ $n$ è¡¨ç¤ºæ ‘ä¸Šç»“ç‚¹çš„ä¸ªæ•°ã€‚

åœ¨ä¸€æ£µæ ‘ä¸­ï¼Œå¦‚æœåˆ é™¤ä¸€ä¸ªé¡¶ç‚¹åå¾—åˆ°çš„æœ€å¤§å­æ ‘çš„é¡¶ç‚¹æ•°æœ€å°‘ï¼Œé‚£ä¹ˆè¿™ä¸ªç‚¹å°±æ˜¯**æ ‘çš„é‡å¿ƒ**ï¼ˆCentroidï¼‰ã€‚

é‡å¿ƒçš„æ€§è´¨ï¼š

1. åˆ é™¤é‡å¿ƒåå¾—åˆ°çš„æ‰€æœ‰å­æ ‘ï¼Œå…¶é¡¶ç‚¹æ•°å¿…ç„¶ä¸è¶…è¿‡ $n/2$ã€‚

	è¯æ˜ï¼šé€‰å–ä»»æ„é¡¶ç‚¹ä½œä¸ºèµ·ç‚¹ï¼Œæ¯æ¬¡éƒ½æ²¿ç€è¾¹å‘æœ€å¤§å­æ ‘çš„æ–¹å‘ç§»åŠ¨ï¼Œæœ€ç»ˆä¸€å®šä¼šåˆ°è¾¾æŸä¸ªé¡¶ç‚¹ï¼Œå°†å…¶åˆ é™¤åå¾—åˆ°çš„æ‰€æœ‰å­æ ‘çš„é¡¶ç‚¹æ•°éƒ½ä¸è¶…è¿‡ $n/2$ã€‚å¦‚æœè¿™æ ·çš„ç‚¹å­˜åœ¨çš„è¯ï¼Œé‚£ä¹ˆä¹Ÿå°±å¯ä»¥è¯æ˜åˆ é™¤é‡å¿ƒåå¾—åˆ°çš„æ‰€æœ‰å­æ ‘çš„é¡¶ç‚¹æ•°éƒ½ä¸è¶…è¿‡ $n/2$ã€‚

	è®°å½“å‰é¡¶ç‚¹ä¸º $v$ï¼Œå¦‚æœé¡¶ç‚¹ $v$ å·²ç»æ»¡è¶³ä¸Šè¿°æ¡ä»¶åˆ™åœæ­¢ã€‚å¦åˆ™ï¼Œä¸é¡¶ç‚¹ $v$ é‚»æ¥çš„æŸä¸ªå­æ ‘çš„é¡¶ç‚¹æ•°å¿…ç„¶å¤§äº $n/2$ã€‚å‡è®¾é¡¶ç‚¹ $v$ ä¸è¯¥å­æ ‘ä¸­çš„é¡¶ç‚¹ $w$ é‚»æ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æŠŠé¡¶ç‚¹ $w$ ä½œä¸ºæ–°çš„é¡¶ç‚¹ $v$ã€‚ä¸æ–­é‡å¤è¿™ä¸€æ­¥éª¤ï¼Œå¿…ç„¶ä¼šåœ¨æœ‰é™æ­¥åœæ­¢ã€‚è¿™æ˜¯å› ä¸ºå¯¹äºç§»åŠ¨ä¸­æ‰€ç”¨çš„è¾¹ $(v, w)$ï¼Œå¿…æœ‰ $v$ ä¾§çš„å­æ ‘çš„é¡¶ç‚¹æ•°å°äº $n/2$ï¼Œ$w$ ä¾§çš„å­æ ‘çš„é¡¶ç‚¹æ•°å¤§äº $n/2$ï¼Œæ‰€ä»¥ä¸å¯èƒ½å†ä» $w$ ç§»åŠ¨åˆ° $v$ã€‚å› è€Œè¯¥æ“ä½œæ°¸è¿œä¸ä¼šå›åˆ°å·²ç»ç»è¿‡çš„é¡¶ç‚¹ï¼Œè€Œé¡¶ç‚¹æ•°åˆæ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥ç®—æ³•å¿…ç„¶åœ¨æœ‰é™æ­¥ç»ˆæ­¢ã€‚
2. æ ‘ä¸­æ‰€æœ‰é¡¶ç‚¹åˆ°æŸä¸ªé¡¶ç‚¹çš„è·ç¦»å’Œä¸­ï¼Œåˆ°é‡å¿ƒçš„è·ç¦»å’Œæ˜¯æœ€å°çš„ï¼›å¦‚æœæœ‰ä¸¤ä¸ªé‡å¿ƒï¼Œé‚£ä¹ˆåˆ°å®ƒä»¬çš„è·ç¦»å’Œä¸€æ ·ã€‚
3. æŠŠä¸¤æ£µæ ‘é€šè¿‡ä¸€æ¡è¾¹ç›¸è¿å¾—åˆ°ä¸€æ£µæ–°çš„æ ‘ï¼Œé‚£ä¹ˆæ–°çš„æ ‘çš„é‡å¿ƒåœ¨è¿æ¥åŸæ¥ä¸¤æ£µæ ‘çš„é‡å¿ƒçš„è·¯å¾„ä¸Šã€‚
4. åœ¨ä¸€æ£µæ ‘ä¸Šæ·»åŠ æˆ–åˆ é™¤ä¸€ä¸ªå¶å­ï¼Œé‚£ä¹ˆå®ƒçš„é‡å¿ƒæœ€å¤šåªç§»åŠ¨ä¸€æ¡è¾¹çš„è·ç¦»ã€‚

> æ›´å¤šè¯æ˜è¯·è§ï¼š[æ ‘çš„é‡å¿ƒçš„æ€§è´¨åŠå…¶è¯æ˜ - suxxsfe - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/suxxsfe/p/13543253.html)

## å¯»æ‰¾æ ‘çš„é‡å¿ƒ

æ ¹æ®é‡å¿ƒçš„å®šä¹‰ï¼Œå…ˆä»¥ $1$ ä¸ºæ ¹è¿›è¡Œ DFSã€‚åœ¨é€’å½’ä¸­è®¡ç®—å­æ ‘å¤§å° $siz[u]$ï¼Œå¹¶æ±‚å‡ºæœ€å¤§çš„å­æ ‘çš„å¤§å° $maxs[u]$ï¼Œæ¯”è¾ƒå‡ºé‡å¿ƒ $centroid$ã€‚

```cpp
void getCentroid(int u, int fa, int s) {
Â  siz[u] = 1;
Â  maxs[u] = 0;
Â  for (int i = head[u]; i != 0; i = nxt[i]) {
Â  Â  if (to[i] == fa)
Â  Â  Â  continue;
Â  Â  getCentroid(to[i], u, s);
Â  Â  siz[u] += siz[to[i]];
Â  Â  maxs[u] = max(maxs[u], siz[to[i]]);
Â  }
  // â€œå‘ä¸Šâ€ çš„éƒ¨åˆ†ä¹Ÿæ˜¯è¯¥ç»“ç‚¹çš„å­æ ‘
Â  maxs[u] = max(maxs[u], s - siz[u]);
Â  if (maxs[u] < maxs[centroid] || !centroid) centroid = u;
}
int main() {
Â  centroid = 0;
Â  getCentroid(1, 0, n);
Â  return 0;
}
```

æäº¤ï¼š[CSES - Finding a Centroid](https://cses.fi/problemset/task/2079)

## ç‚¹åˆ†æ²»

æˆ‘ä»¬å¯ä»¥ç”¨ç‚¹åˆ†æ²»è§£å†³å…³äºç»Ÿè®¡æ ‘ä¸Šè·¯å¾„çš„é—®é¢˜ã€‚

### ä¾‹ä¸€

> [Luogu P3806ã€æ¨¡æ¿ã€‘ç‚¹åˆ†æ²» 1](https://www.luogu.com.cn/problem/P3806)ï¼šç»™å®šä¸€æ£µæœ‰ $n$ ä¸ªç‚¹çš„å¸¦è¾¹æƒæ ‘ï¼Œ$m$ æ¬¡è¯¢é—®ï¼Œæ¯æ¬¡è¯¢é—®ç»™å‡º $k$ï¼Œè¯¢é—®æ ‘ä¸Šè·ç¦»ä¸º $k$ çš„ç‚¹å¯¹æ˜¯å¦å­˜åœ¨ã€‚
> 
> $n\le 10000,m\le 100,k\le 10000000$

æš´åŠ›çš„åšæ³•è‡³å°‘éœ€è¦ $O(n^{2})$ï¼Œæ˜¾ç„¶ä¼šè¶…æ—¶ï¼Œæ‰€ä»¥è€ƒè™‘åˆ†æ²»ã€‚

å¦‚ä½•åˆ†å‰²å‘¢ï¼Ÿå¦‚æœéšæ„é€‰æ‹©é¡¶ç‚¹çš„è¯ï¼Œé€’å½’çš„æ·±åº¦å¯èƒ½é€€åŒ–æˆ $O(n)$ã€‚è‹¥æˆ‘ä»¬æ¯æ¬¡é€‰æ‹©å­æ ‘çš„**é‡å¿ƒ**ä½œä¸ºæ–°çš„æ ¹ç»“ç‚¹ï¼Œå¯ä»¥è®©é€’å½’çš„å±‚æ•°æœ€å°‘ã€‚å› ä¸ºæ¯æ¬¡æ ‘çš„å¤§å°è‡³å°‘å‡åŠï¼Œæ‰€ä»¥é€’å½’çš„æ·±åº¦æ˜¯ $O(log n)$ã€‚

è®¾å½“å‰çš„æ ¹ç»“ç‚¹æ˜¯ $rt$ã€‚

å¯¹äºæ¯ä¸€æ¡è·¯å¾„ $(u, v)$ï¼Œå¿…ç„¶æ»¡è¶³ä»¥ä¸‹ä¸‰ç§æƒ…å†µä¹‹ä¸€ï¼š

1. é¡¶ç‚¹ $u, v$ åœ¨ $rt$ çš„åŒä¸€å­æ ‘å†…ã€‚
2. é¡¶ç‚¹ $u, v$ åˆ†åˆ«åœ¨ $rt$ çš„ä¸åŒå­æ ‘å†…ã€‚
3. é¡¶ç‚¹ $u, v$ å…¶ä¸­ä¸€ä¸ªæ˜¯ $rt$ã€‚

å¯¹äºç¬¬ (1) ç§æƒ…å†µï¼Œå¯ä»¥é€’å½’åè½¬åŒ–æˆå¦å¤–çš„æƒ…å†µã€‚å¯¹äºç¬¬ (2) ç§æƒ…å†µï¼Œä»é¡¶ç‚¹ $u$ åˆ°é¡¶ç‚¹ $v$ çš„è·¯å¾„å¿…ç„¶ç»è¿‡æ ¹ç»“ç‚¹ $rt$ï¼Œåªè¦æ±‚å‡ºæ¯ä¸ªé¡¶ç‚¹åˆ° $rt$ çš„è·ç¦»ï¼Œå°±å¯ä»¥ç»Ÿè®¡å‡ºç­”æ¡ˆã€‚å¯¹äºç¬¬ (3) ç§æƒ…å†µï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ªåˆ° $rt$ è·ç¦»ä¸º $0$ çš„é¡¶ç‚¹ï¼Œå°±è½¬åŒ–ä¸ºäº†ç¬¬ (2) ç§æƒ…å†µã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ç¬¬ (1) ç§æƒ…å†µä¸­ç»Ÿè®¡çš„åŒä¸€å­æ ‘çš„é¡¶ç‚¹å¯¹ï¼Œè¦é¿å…åœ¨ç¬¬ (2) ç§æƒ…å†µä¸­è¢«é‡å¤ç»Ÿè®¡ã€‚é€šè¿‡**å®¹æ–¥**å’Œç±»ä¼¼äº**æ ‘ä¸ŠèƒŒåŒ…**çš„æ–¹æ³•å¯ä»¥å»é‡ã€‚

æœ€åçš„æ—¶é—´å¤æ‚åº¦æ˜¯ $O(nlog^{2}n)$ã€‚

[RECORD](https://www.luogu.com.cn/record/82315924)ã€‚

```cpp
int n, m;
int L, p;
int centroid;
bool vis[MAXN], cnt[MAXW], ans[MAXM];
int ask[MAXM];
vector< std::pair< int, int > > g[MAXN];
int dis[MAXN];
int siz[MAXN], maxs[MAXN];

void getCentroid(int u, int fa, int s) {
  siz[u] = 1;
  maxs[u] = 0;
  for (auto i : g[u]) {
    if (i.first == fa || vis[i.first]) continue;
    getCentroid(i.first, u, s);
    siz[u] += siz[i.first];
    maxs[u] = std::max(maxs[u], siz[i.first]);
  }
  maxs[u] = std::max(maxs[u], s - siz[u]);
  if (maxs[u] < maxs[centroid] || !centroid)
    centroid = u;
}

// è·å–å­æ ‘ä¸­æ‰€æœ‰ç‚¹åˆ°é‡å¿ƒçš„è·ç¦»
void getDis(int u, int fa, int d) {
  dis[p++] = d;
  for (auto i : g[u]) {
    if (i.first == fa || vis[i.first]) continue;
    getDis(i.first, u, d + i.second);
  }
}
void calc() {
  L = p = 0;
  cnt[0] = 1;
  // ç±»ä¼¼äºæ ‘ä¸ŠèƒŒåŒ…
  for (auto i : g[centroid]) {
    if (vis[i.first]) continue;
    getDis(i.first, centroid, i.second);
    
    // ä¸€æ£µä¸€æ£µå­æ ‘åˆå¹¶ï¼Œä¸ä¼šé‡å¤ç»Ÿè®¡
    for (int i = L; i < p; i++) {
      for (int j = 0; j < m; j++) {
        if (dis[i] > ask[j]) continue;
        ans[j] |= cnt[ask[j] - dis[i]];
      }
    }
    for (int j = L; j < p; j++)
      cnt[dis[j]] = 1;
    L = p;
  }
  
  // è¿˜åŸ cnt æ•°ç»„
  for (int i = 0; i < p; i++)
    cnt[dis[i]] = 0;  // ä¸èƒ½ç”¨ memset
}
void solve(int u, int size) {
  centroid = 0;
  getCentroid(u, -1, size);
  getCentroid(centroid, -1, size);  // å†æ±‚ä¸€æ¬¡ sizï¼Œé˜²æ­¢åé¢æ‰¾é‡å¿ƒæ—¶å‡ºé”™
  vis[centroid] = true;
  calc();
  for (auto i : g[centroid]) {
    if (vis[i.first]) continue;
    solve(i.first, siz[i.first]);
  }
}
int main() {
  solve(1, n);
  for (int i = 0; i < m; i++) {
    if (ans[i]) cout << "AYE\n";
    else cout << "NAY\n";
  }
  return 0;
}
```

**éœ€è¦æ³¨æ„çš„ç»†èŠ‚**ï¼š

- åˆ†æ²»çš„æ—¶å€™æ±‚å‡ºæ–°çš„é‡å¿ƒä¹‹åï¼Œä¹Ÿè¦**å†æ¬¡**æ±‚å­æ ‘ $siz$ã€‚

	è¯¦è§ï¼š[ä¸€ç§åŸºäºé”™è¯¯çš„å¯»æ‰¾é‡å¿ƒæ–¹æ³•çš„ç‚¹åˆ†æ²»çš„å¤æ‚åº¦åˆ†æ - åšå®¢ - liu_cheng_aoçš„åšå®¢ (uoj.ac)](https://liu-cheng-ao.blog.uoj.ac/blog/2969)

  è´¦å· `920848348` è¯„è®ºï¼š

  ![graph](https://raw.githubusercontent.com/ChungZH/img/main/centroid-decomposition/graph.png)
  > å¯¹äºå¤§éƒ¨åˆ†ç‚¹åˆ†æ²»çš„ä»£ç ä¸­ï¼Œä¸èƒ½ç›´æ¥ `size = siz[v]`ï¼Œå¦åˆ™ä¼šå¯¼è‡´åé¢çš„é‡å¿ƒæ±‚é”™ï¼ˆå¯ä»¥ç”¨ä¸‹é¢çš„æ ·ä¾‹è¯•ä¸€ä¸‹ï¼Œç„¶åè¾“å‡ºé‡å¿ƒèŠ‚ç‚¹çœ‹ä¸€ä¸‹ï¼Œä½ ä¼šå‘ç°ä» $6$->$3$ è¿™ä¸€å¤§å—çš„é‡å¿ƒåº”è¯¥æ˜¯ $2$ï¼Œè€Œä»£ç è¾“å‡ºæ˜¯ $1$ã€‚åŸå› åœ¨äºï¼š
  > 
  > ç”±äºä¸€å¼€å§‹ä» ç‚¹ $1$ å¼€å§‹æ‰¾æ•´æ£µæ ‘çš„é‡å¿ƒï¼Œæ­¤æ—¶çš„ $siz[u]$ è¡¨ç¤ºçš„ä»…ä»…æ˜¯ä»¥ 1 ä¸ºæ ¹ç»“ç‚¹çš„æ ‘ä¸­ï¼Œ$u$ çš„å­æ ‘å¤§å°ã€‚é‚£ä¹ˆç°åœ¨é‡å¿ƒ $root$ æ‰¾åˆ°äº†ï¼Œé‚£ä¹ˆä»è¿™æ•´æ£µæ ‘çš„é‡å¿ƒ $root$ å¼€å§‹æ·±æœæ—¶ï¼Œè‹¥æœ‰è¾¹ $root$->$v$ ï¼Œè€Œæ­¤æ—¶çš„ $siz[v]$ çš„å€¼å¹¶ä¸æ˜¯ä»¥ $v$ ä¸ºæ ¹çš„å­æ ‘çš„å¤§å°ï¼ˆè¿™ä¸ªå­æ ‘å½“ç„¶ä¸åŒ…æ‹¬çˆ¶äº² $root$ é‚£ä¸€å—ï¼‰ã€‚å…·ä½“ä¸ºä»€ä¹ˆï¼Œè¿™é‡Œç»™ä¸€ç»„æ ·ä¾‹ï¼Œå¤§å®¶å¯ä»¥åœ¨å›¾ä¸­ç”»ä¸€ä¸‹ã€‚
  æ­¤æ ·ä¾‹çš„å¯¹åº”é¢˜ç›®ä¸º [Luogu P3806ã€æ¨¡æ¿ã€‘ç‚¹åˆ†æ²» 1](https://www.luogu.com.cn/problem/P3806)ã€‚
  > 
  > ç„¶åæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥ï¼š
  > 
  > å…ˆä» $1$ å¼€å§‹ dfs ï¼Œç»Ÿè®¡ $siz$ æ•°ç»„ï¼Œæ­¤æ—¶å¾ˆæ¸…æ™°çš„çŸ¥é“ $siz[3] = 7$ ï¼Œå› ä¸ºæ˜¯ä»¥ $1$ ä¸ºæ ¹æ·±æœçš„ã€‚å¾ˆæ˜æ˜¾ï¼Œä¸€å¼€å§‹è¿™æ•´æ£µæ ‘çš„é‡å¿ƒæ˜¯ 6 å·èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼š
  > 
  > å½“ä»ç‚¹ $6$ å¼€å§‹ dfs æ—¶ï¼Œæœ‰ $6$->$3$ è¿™æ¡è¾¹ï¼Œé‚£ä¹ˆæŒ‰ç†æ¥è¯´ï¼Œ$size = siz[3]$ï¼Œæ­¤æ—¶ $size$ è¡¨ç¤ºçš„æ˜¯ä»¥ $3$ ä¸ºæ ¹çš„å­æ ‘çš„å¤§å°ï¼Œå¯çœ‹å›¾ä¸Šæ˜æ˜æ˜¯ $5$ å•Šï¼ˆåœ¨ç‚¹ $3$ çš„å·¦è¾¹ï¼Œä¸åŒ…å«ç‚¹ $6$ é‚£è¾¹ï¼‰ã€‚å¯æ˜¯æ­¤æ—¶çš„ $siz[3]$ ä¸º $7$ï¼Œè€Œå¹¶éæ˜¯ $5$ ã€‚è¿™æ˜¯ç”±äºé€‰å®šçš„æ·±æœèŠ‚ç‚¹ä¸åŒï¼Œç»Ÿè®¡çš„ä¸åŒè€Œå¯¼è‡´çš„ã€‚$siz[3]$ çš„æ­£ç¡®å€¼ç†åº”æ¥è‡ªäºä» ç‚¹ $6$ å¼€å§‹æ·±æœçš„å€¼ã€‚
  > æ•…æˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼Œç”¨ `getroot(1,0)` æ‰¾åˆ°æ•´æ£µæ ‘çš„é‡å¿ƒä¹‹åï¼Œå†æ¥ä¸€æ¬¡ `getroot(root, 0)`ï¼Œæ¥ç¡®å®šä»¥é‡å¿ƒä¸ºæ ¹ç»“ç‚¹æ—¶çš„ $siz$ æ•°ç»„ã€‚è¿™ä¸‹å°±å¯ä»¥ç›´æ¥ `size = siz[v]` äº†ã€‚
  ```
  11 1
  6 7 1
  6 8 1
  7 9 1
  7 10 1
  8 11 1
  1 2 1
  1 3 1
  2 4 1
  2 5 1
  3 6 1
  2
  ```
- ä¸è¦ç”¨ `memset` ç²—æš´è¿˜åŸï¼Œä¼šæµªè´¹å¾ˆå¤šæ—¶é—´ã€‚

### ä¾‹äºŒ

> [Luogu P4178 Tree](https://www.luogu.com.cn/problem/P4178)ï¼šç»™å®šä¸€æ£µæœ‰ $n$ ä¸ªç‚¹çš„å¸¦æƒæ ‘ï¼Œç»™å‡º $k$ï¼Œè¯¢é—®æ ‘ä¸Šè·ç¦»å°äºç­‰äº $k$ çš„ç‚¹å¯¹æ•°é‡ã€‚
> 
> $n\le 40000,k\le 20000,w_i\le 1000$

è¿™é¢˜æ–¹æ³•æ¯”è¾ƒå¤šã€‚ä¸‹é¢çš„ä»£ç ç”¨ **å®¹æ–¥** è¿›è¡Œå»é‡å’Œ **åŒæŒ‡é’ˆ** ï¼ˆé™¤æ­¤ä¹‹å¤–è¿˜å¯ä»¥ç”¨**äºŒåˆ†**ï¼‰ç»Ÿè®¡ç­”æ¡ˆã€‚

[RECORD](https://www.luogu.com.cn/record/82350911)ã€‚

```cpp
int calc(int u, int w) {
  dis.clear();
  getDis(u, -1, w);
  sort(dis.begin(), dis.end());
  int sum = 0;
  int L = 0, R = dis.size() - 1;  // åŒæŒ‡é’ˆ
  while (L < R) {
    if (dis[L] + dis[R] <= k)
      sum += R - L, L++;
    else
      R--;
  }
  return sum;
}
void solve(int u, int size) {
  centroid = 0;
  getCentroid(u, -1, size);
  getCentroid(centroid, -1, size);
  vis[centroid] = true;
  ans += calc(centroid, 0);
  for (auto i : g[centroid]) {
    if (vis[i.first]) continue;
    ans -= calc(i.first, i.second); // å®¹æ–¥ã€‚å»é™¤é”™è¯¯çš„ç­”æ¡ˆã€‚
  }
  for (auto i : g[centroid]) {
    if (vis[i.first]) continue;
    solve(i.first, siz[i.first]);
  }
}
```

### ä¾‹ä¸‰

æš‚ä¸”å’•å’•å’•ã€‚ğŸ•Š

> [Luogu P4149 [IOI2011]Race](https://www.luogu.com.cn/problem/P4149)ï¼šç»™å®šä¸€æ£µæœ‰ $n$ ä¸ªç‚¹çš„å¸¦æƒæ ‘ï¼Œç»™å‡º $k$ï¼Œæ±‚ä¸€æ¡ç®€å•è·¯å¾„ã€‚æƒå€¼å’Œç­‰äº $k$ï¼Œä¸”è¾¹çš„æ•°é‡æœ€å°ã€‚
> 
> $n\le 200000,k,w_i\le 1000000$

å¼€ä¸ªæ¡¶æ•°ç»„è®°å½•æœ€å°è¾¹æ•°å³å¯ã€‚

[RECORD](https://www.luogu.com.cn/record/82407305)ã€‚

```cpp
// æ¡¶æ•°ç»„ï¼Œminn[i] è¡¨ç¤ºæƒå€¼å’Œä¸º i çš„è·¯å¾„çš„æœ€å°è¾¹æ•°
int minn[MAXK];

// d è¡¨ç¤ºæƒå€¼å’Œï¼Œb è¡¨ç¤ºè¾¹æ•°
void getDis(int u, int fa, int d, int b) {
  if (d > k) return;
  dis.emplace_back(d, b);
  for (auto i : g[u]) {
    if (i.first == fa || vis[i.first]) continue;
    getDis(i.first, u, d + i.second, b + 1);
  }
}
void calc(int u) {
  minn[0] = 0;
  tdis.clear();
  for (auto i : g[u]) {
    if (vis[i.first]) continue;
    dis.clear();
    getDis(i.first, u, i.second, 1);
    for (auto j : dis) {
      if (minn[k - j.first] != -1) {  // å¯ä»¥æ‹¼å‡‘æˆæƒå€¼å’Œä¸º k çš„è·¯å¾„
        if (ans == -1)
          ans = minn[k - j.first] + j.second;
        else
          ans = std::min(ans, minn[k - j.first] + j.second);
      }
    }
    // æ›´æ–°æ¡¶æ•°ç»„
    for (auto j : dis) {
      tdis.push_back(j);
      if (minn[j.first] == -1)
        minn[j.first] = j.second;
      else
        minn[j.first] = std::min(minn[j.first], j.second);
    }
  }
  // è¿˜åŸ minn æ•°ç»„
  for (auto i : tdis) {
    minn[i.first] = -1;
  }
}
void solve(int u, int size) {
  centroid = 0;
  getCentroid(u, -1, size);
  getCentroid(centroid, -1, size);
  vis[centroid] = true;
  calc(centroid);
  for (auto i : g[centroid]) {
    if (vis[i.first]) continue;
    solve(i.first, siz[i.first]);
  }
}
```

## ä¹ é¢˜

- [x] [Luogu P2634 [å›½å®¶é›†è®­é˜Ÿ]èªèªå¯å¯](https://www.luogu.com.cn/problem/P2634)
- [ ] [Luogu P3714 [BJOI2017]æ ‘çš„éš¾é¢˜](https://www.luogu.com.cn/problem/P3714)

## å‚è€ƒèµ„æ–™

- ã€ŠæŒ‘æˆ˜ç¨‹åºè®¾è®¡ç«èµ›ã€‹
- [OI Wiki](https://oi-wiki.org/)

ğŸ™‡â€